import { __awaiter } from "tslib";
import { MarkdownView, } from "obsidian";
import { escape_RegExp } from "utils/Utils";
export class CursorJumper {
    constructor(app) {
        this.app = app;
    }
    jump_to_next_cursor_location() {
        return __awaiter(this, void 0, void 0, function* () {
            const active_editor = this.app.workspace.activeEditor;
            if (!active_editor || !active_editor.editor) {
                return;
            }
            const content = active_editor.editor.getValue();
            const { new_content, positions } = this.replace_and_get_cursor_positions(content);
            if (positions) {
                const fold_info = active_editor instanceof MarkdownView
                    ? active_editor.currentMode.getFoldInfo()
                    : null;
                active_editor.editor.setValue(new_content);
                // only expand folds that have a cursor placed within it's bounds
                if (fold_info && Array.isArray(fold_info.folds)) {
                    positions.forEach((position) => {
                        fold_info.folds = fold_info.folds.filter((fold) => fold.from > position.line || fold.to < position.line);
                    });
                    if (active_editor instanceof MarkdownView) {
                        active_editor.currentMode.applyFoldInfo(fold_info);
                    }
                }
                this.set_cursor_location(positions);
            }
            // enter insert mode for vim users
            if (this.app.vault.getConfig("vimMode")) {
                // @ts-ignore
                const cm = active_editor.editor.cm.cm;
                // @ts-ignore
                window.CodeMirrorAdapter.Vim.handleKey(cm, "i", "mapping");
            }
        });
    }
    get_editor_position_from_index(content, index) {
        const substr = content.slice(0, index);
        let l = 0;
        let offset = -1;
        let r = -1;
        for (; (r = substr.indexOf("\n", r + 1)) !== -1; l++, offset = r)
            ;
        offset += 1;
        const ch = content.slice(offset, index).length;
        return { line: l, ch: ch };
    }
    replace_and_get_cursor_positions(content) {
        let cursor_matches = [];
        let match;
        const cursor_regex = new RegExp("<%\\s*tp.file.cursor\\((?<order>[0-9]*)\\)\\s*%>", "g");
        while ((match = cursor_regex.exec(content)) != null) {
            cursor_matches.push(match);
        }
        if (cursor_matches.length === 0) {
            return {};
        }
        cursor_matches.sort((m1, m2) => {
            return (Number(m1.groups && m1.groups["order"]) -
                Number(m2.groups && m2.groups["order"]));
        });
        const match_str = cursor_matches[0][0];
        cursor_matches = cursor_matches.filter((m) => {
            return m[0] === match_str;
        });
        const positions = [];
        let index_offset = 0;
        for (const match of cursor_matches) {
            const index = match.index - index_offset;
            positions.push(this.get_editor_position_from_index(content, index));
            content = content.replace(new RegExp(escape_RegExp(match[0])), "");
            index_offset += match[0].length;
            // For tp.file.cursor(), we keep the default top to bottom
            if (match[1] === "") {
                break;
            }
        }
        return { new_content: content, positions: positions };
    }
    set_cursor_location(positions) {
        const active_editor = this.app.workspace.activeEditor;
        if (!active_editor || !active_editor.editor) {
            return;
        }
        const editor = active_editor.editor;
        const selections = [];
        for (const pos of positions) {
            selections.push({ from: pos });
        }
        const transaction = {
            selections: selections,
        };
        editor.transaction(transaction);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ3Vyc29ySnVtcGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2VkaXRvci9DdXJzb3JKdW1wZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFLSCxZQUFZLEdBQ2YsTUFBTSxVQUFVLENBQUM7QUFDbEIsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUU1QyxNQUFNLE9BQU8sWUFBWTtJQUNyQixZQUFvQixHQUFRO1FBQVIsUUFBRyxHQUFILEdBQUcsQ0FBSztJQUFHLENBQUM7SUFFMUIsNEJBQTRCOztZQUM5QixNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUM7WUFDdEQsSUFBSSxDQUFDLGFBQWEsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLEVBQUU7Z0JBQ3pDLE9BQU87YUFDVjtZQUNELE1BQU0sT0FBTyxHQUFHLGFBQWEsQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLENBQUM7WUFFaEQsTUFBTSxFQUFFLFdBQVcsRUFBRSxTQUFTLEVBQUUsR0FDNUIsSUFBSSxDQUFDLGdDQUFnQyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ25ELElBQUksU0FBUyxFQUFFO2dCQUNYLE1BQU0sU0FBUyxHQUNYLGFBQWEsWUFBWSxZQUFZO29CQUNqQyxDQUFDLENBQUMsYUFBYSxDQUFDLFdBQVcsQ0FBQyxXQUFXLEVBQUU7b0JBQ3pDLENBQUMsQ0FBQyxJQUFJLENBQUM7Z0JBQ2YsYUFBYSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsV0FBcUIsQ0FBQyxDQUFDO2dCQUNyRCxpRUFBaUU7Z0JBQ2pFLElBQUksU0FBUyxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxFQUFFO29CQUM3QyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBUSxFQUFFLEVBQUU7d0JBQzNCLFNBQVMsQ0FBQyxLQUFLLEdBQUcsU0FBUyxD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LE1BQU0sV0FBVyxHQUFzQjtZQUNuQyxVQUFVLEVBQUUsVUFBVTtTQUN6QixDQUFDO1FBQ0YsTUFBTSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUNwQyxDQUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gICAgQXBwLFxyXG4gICAgRWRpdG9yUG9zaXRpb24sXHJcbiAgICBFZGl0b3JSYW5nZU9yQ2FyZXQsXHJcbiAgICBFZGl0b3JUcmFuc2FjdGlvbixcclxuICAgIE1hcmtkb3duVmlldyxcclxufSBmcm9tIFwib2JzaWRpYW5cIjtcclxuaW1wb3J0IHsgZXNjYXBlX1JlZ0V4cCB9IGZyb20gXCJ1dGlscy9VdGlsc1wiO1xyXG5cclxuZXhwb3J0IGNsYXNzIEN1cnNvckp1bXBlciB7XHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFwcDogQXBwKSB7fVxyXG5cclxuICAgIGFzeW5jIGp1bXBfdG9fbmV4dF9jdXJzb3JfbG9jYXRpb24oKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICAgICAgY29uc3QgYWN0aXZlX2VkaXRvciA9IHRoaXMuYXBwLndvcmtzcGFjZS5hY3RpdmVFZGl0b3I7XHJcbiAgICAgICAgaWYgKCFhY3RpdmVfZWRpdG9yIHx8ICFhY3RpdmVfZWRpdG9yLmVkaXRvcikge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGNvbnRlbnQgPSBhY3RpdmVfZWRpdG9yLmVkaXRvci5nZXRWYWx1ZSgpO1xyXG5cclxuICAgICAgICBjb25zdCB7IG5ld19jb250ZW50LCBwb3NpdGlvbnMgfSA9XHJcbiAgICAgICAgICAgIHRoaXMucmVwbGFjZV9hbmRfZ2V0X2N1cnNvcl9wb3NpdGlvbnMoY29udGVudCk7XHJcbiAgICAgICAgaWYgKHBvc2l0aW9ucykge1xyXG4gICAgICAgICAgICBjb25zdCBmb2xkX2luZm8gPVxyXG4gICAgICAgICAgICAgICAgYWN0aXZlX2VkaXRvciBpbnN0YW5jZW9mIE1hcmtkb3duVmlld1xyXG4gICAgICAgICAgICAgICAgICAgID8gYWN0aXZlX2VkaXRvci5jdXJyZW50TW9kZS5nZXRGb2xkSW5mbygpXHJcbiAgICAgICAgICAgICAgICAgICAgOiBudWxsO1xyXG4gICAgICAgICAgICBhY3RpdmVfZWRpdG9yLmVkaXRvci5zZXRWYWx1ZShuZXdfY29udGVudCBhcyBzdHJpbmcpO1xyXG4gICAgICAgICAgICAvLyBvbmx5IGV4cGFuZCBmb2xkcyB0aGF0IGhhdmUgYSBjdXJzb3IgcGxhY2VkIHdpdGhpbiBpdCdzIGJvdW5kc1xyXG4gICAgICAgICAgICBpZiAoZm9sZF9pbmZvICYmIEFycmF5LmlzQXJyYXkoZm9sZF9pbmZvLmZvbGRzKSkge1xyXG4gICAgICAgICAgICAgICAgcG9zaXRpb25zLmZvckVhY2goKHBvc2l0aW9uKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgZm9sZF9pbmZvLmZvbGRzID0gZm9sZF9pbmZvLmZvbGRzLmZpbHRlcihcclxuICAgICAgICAgICAgICAgICAgICAgICAgKGZvbGQpID0+XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb2xkLmZyb20gPiBwb3NpdGlvbi5saW5lIHx8IGZvbGQudG8gPCBwb3NpdGlvbi5saW5lXHJcbiAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgaWYgKGFjdGl2ZV9lZGl0b3IgaW5zdGFuY2VvZiBNYXJrZG93blZpZXcpIHtcclxuICAgICAgICAgICAgICAgICAgICBhY3RpdmVfZWRpdG9yLmN1cnJlbnRNb2RlLmFwcGx5Rm9sZEluZm8oZm9sZF9pbmZvKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLnNldF9jdXJzb3JfbG9jYXRpb24ocG9zaXRpb25zKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIGVudGVyIGluc2VydCBtb2RlIGZvciB2aW0gdXNlcnNcclxuICAgICAgICBpZiAodGhpcy5hcHAudmF1bHQuZ2V0Q29uZmlnKFwidmltTW9kZVwiKSkge1xyXG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlXHJcbiAgICAgICAgICAgIGNvbnN0IGNtID0gYWN0aXZlX2VkaXRvci5lZGl0b3IuY20uY207XHJcbiAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcclxuICAgICAgICAgICAgd2luZG93LkNvZGVNaXJyb3JBZGFwdGVyLlZpbS5oYW5kbGVLZXkoY20sIFwiaVwiLCBcIm1hcHBpbmdcIik7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGdldF9lZGl0b3JfcG9zaXRpb25fZnJvbV9pbmRleChcclxuICAgICAgICBjb250ZW50OiBzdHJpbmcsXHJcbiAgICAgICAgaW5kZXg6IG51bWJlclxyXG4gICAgKTogRWRpdG9yUG9zaXRpb24ge1xyXG4gICAgICAgIGNvbnN0IHN1YnN0ciA9IGNvbnRlbnQuc2xpY2UoMCwgaW5kZXgpO1xyXG5cclxuICAgICAgICBsZXQgbCA9IDA7XHJcbiAgICAgICAgbGV0IG9mZnNldCA9IC0xO1xyXG4gICAgICAgIGxldCByID0gLTE7XHJcbiAgICAgICAgZm9yICg7IChyID0gc3Vic3RyLmluZGV4T2YoXCJcXG5cIiwgciArIDEpKSAhPT0gLTE7IGwrKywgb2Zmc2V0ID0gcik7XHJcbiAgICAgICAgb2Zmc2V0ICs9IDE7XHJcblxyXG4gICAgICAgIGNvbnN0IGNoID0gY29udGVudC5zbGljZShvZmZzZXQsIGluZGV4KS5sZW5ndGg7XHJcblxyXG4gICAgICAgIHJldHVybiB7IGxpbmU6IGwsIGNoOiBjaCB9O1xyXG4gICAgfVxyXG5cclxuICAgIHJlcGxhY2VfYW5kX2dldF9jdXJzb3JfcG9zaXRpb25zKGNvbnRlbnQ6IHN0cmluZyk6IHtcclxuICAgICAgICBuZXdfY29udGVudD86IHN0cmluZztcclxuICAgICAgICBwb3NpdGlvbnM/OiBFZGl0b3JQb3NpdGlvbltdO1xyXG4gICAgfSB7XHJcbiAgICAgICAgbGV0IGN1cnNvcl9tYXRjaGVzID0gW107XHJcbiAgICAgICAgbGV0IG1hdGNoO1xyXG4gICAgICAgIGNvbnN0IGN1cnNvcl9yZWdleCA9IG5ldyBSZWdFeHAoXHJcbiAgICAgICAgICAgIFwiPCVcXFxccyp0cC5maWxlLmN1cnNvclxcXFwoKD88b3JkZXI+WzAtOV0qKVxcXFwpXFxcXHMqJT5cIixcclxuICAgICAgICAgICAgXCJnXCJcclxuICAgICAgICApO1xyXG5cclxuICAgICAgICB3aGlsZSAoKG1hdGNoID0gY3Vyc29yX3JlZ2V4LmV4ZWMoY29udGVudCkpICE9IG51bGwpIHtcclxuICAgICAgICAgICAgY3Vyc29yX21hdGNoZXMucHVzaChtYXRjaCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChjdXJzb3JfbWF0Y2hlcy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgcmV0dXJuIHt9O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY3Vyc29yX21hdGNoZXMuc29ydCgobTEsIG0yKSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiAoXHJcbiAgICAgICAgICAgICAgICBOdW1iZXIobTEuZ3JvdXBzICYmIG0xLmdyb3Vwc1tcIm9yZGVyXCJdKSAtXHJcbiAgICAgICAgICAgICAgICBOdW1iZXIobTIuZ3JvdXBzICYmIG0yLmdyb3Vwc1tcIm9yZGVyXCJdKVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGNvbnN0IG1hdGNoX3N0ciA9IGN1cnNvcl9tYXRjaGVzWzBdWzBdO1xyXG5cclxuICAgICAgICBjdXJzb3JfbWF0Y2hlcyA9IGN1cnNvcl9tYXRjaGVzLmZpbHRlcigobSkgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gbVswXSA9PT0gbWF0Y2hfc3RyO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBbXTtcclxuICAgICAgICBsZXQgaW5kZXhfb2Zmc2V0ID0gMDtcclxuICAgICAgICBmb3IgKGNvbnN0IG1hdGNoIG9mIGN1cnNvcl9tYXRjaGVzKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gbWF0Y2guaW5kZXggLSBpbmRleF9vZmZzZXQ7XHJcbiAgICAgICAgICAgIHBvc2l0aW9ucy5wdXNoKHRoaXMuZ2V0X2VkaXRvcl9wb3NpdGlvbl9mcm9tX2luZGV4KGNvbnRlbnQsIGluZGV4KSk7XHJcblxyXG4gICAgICAgICAgICBjb250ZW50ID0gY29udGVudC5yZXBsYWNlKG5ldyBSZWdFeHAoZXNjYXBlX1JlZ0V4cChtYXRjaFswXSkpLCBcIlwiKTtcclxuICAgICAgICAgICAgaW5kZXhfb2Zmc2V0ICs9IG1hdGNoWzBdLmxlbmd0aDtcclxuXHJcbiAgICAgICAgICAgIC8vIEZvciB0cC5maWxlLmN1cnNvcigpLCB3ZSBrZWVwIHRoZSBkZWZhdWx0IHRvcCB0byBib3R0b21cclxuICAgICAgICAgICAgaWYgKG1hdGNoWzFdID09PSBcIlwiKSB7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHsgbmV3X2NvbnRlbnQ6IGNvbnRlbnQsIHBvc2l0aW9uczogcG9zaXRpb25zIH07XHJcbiAgICB9XHJcblxyXG4gICAgc2V0X2N1cnNvcl9sb2NhdGlvbihwb3NpdGlvbnM6IEVkaXRvclBvc2l0aW9uW10pOiB2b2lkIHtcclxuICAgICAgICBjb25zdCBhY3RpdmVfZWRpdG9yID0gdGhpcy5hcHAud29ya3NwYWNlLmFjdGl2ZUVkaXRvcjtcclxuICAgICAgICBpZiAoIWFjdGl2ZV9lZGl0b3IgfHwgIWFjdGl2ZV9lZGl0b3IuZWRpdG9yKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGVkaXRvciA9IGFjdGl2ZV9lZGl0b3IuZWRpdG9yO1xyXG5cclxuICAgICAgICBjb25zdCBzZWxlY3Rpb25zOiBBcnJheTxFZGl0b3JSYW5nZU9yQ2FyZXQ+ID0gW107XHJcbiAgICAgICAgZm9yIChjb25zdCBwb3Mgb2YgcG9zaXRpb25zKSB7XHJcbiAgICAgICAgICAgIHNlbGVjdGlvbnMucHVzaCh7IGZyb206IHBvcyB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHRyYW5zYWN0aW9uOiBFZGl0b3JUcmFuc2FjdGlvbiA9IHtcclxuICAgICAgICAgICAgc2VsZWN0aW9uczogc2VsZWN0aW9ucyxcclxuICAgICAgICB9O1xyXG4gICAgICAgIGVkaXRvci50cmFuc2FjdGlvbih0cmFuc2FjdGlvbik7XHJcbiAgICB9XHJcbn1cclxuIl19