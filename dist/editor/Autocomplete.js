import { __awaiter } from "tslib";
import { EditorSuggest, } from "obsidian";
import { Documentation, is_function_documentation, is_module_name, } from "./TpDocumentation";
import { shouldRenderDescription, shouldRenderParameters, shouldRenderReturns } from "../settings/RenderSettings/IntellisenseRenderOption";
import { append_bolded_label_with_value_to_parent } from "utils/Utils";
export class Autocomplete extends EditorSuggest {
    constructor(plugin) {
        super(plugin.app);
        //private in_command = false;
        // https://regex101.com/r/ocmHzR/1
        this.tp_keyword_regex = /tp\.(?<module>[a-z]*)?(?<fn_trigger>\.(?<fn>[a-zA-Z_.]*)?)?$/;
        this.documentation = new Documentation(plugin);
        this.intellisense_render_setting = plugin.settings.intellisense_render;
    }
    onTrigger(cursor, editor, _file) {
        const range = editor.getRange({ line: cursor.line, ch: 0 }, { line: cursor.line, ch: cursor.ch });
        const match = this.tp_keyword_regex.exec(range);
        if (!match) {
            return null;
        }
        let query;
        const module_name = (match.groups && match.groups["module"]) || "";
        this.module_name = module_name;
        if (match.groups && match.groups["fn_trigger"]) {
            if (module_name == "" || !is_module_name(module_name)) {
                return null;
            }
            this.function_trigger = true;
            this.function_name = match.groups["fn"] || "";
            query = this.function_name;
        }
        else {
            this.function_trigger = false;
            query = this.module_name;
        }
        const trigger_info = {
            start: { line: cursor.line, ch: cursor.ch - query.length },
            end: { line: cursor.line, ch: cursor.ch },
            query: query,
        };
        this.latest_trigger_info = trigger_info;
        return trigger_info;
    }
    getSuggestions(context) {
        return __awaiter(this, void 0, void 0, function* () {
            let suggestions;
            if (this.module_name && this.function_trigger) {
                suggestions = (yield this.documentation.get_all_functions_documentation(this.module_name, this.function_name));
            }
            else {
                suggestions = this.documentation.get_all_modules_documentation();
            }
            if (!suggestions) {
                return [];
            }
            return suggestions.filter((s) => s.queryKey.toLowerCase().startsWith(context.query.toLowerCase()));
        });
    }
    renderSuggestion(value, el) {
        el.createEl("b", { text: value.name });
        if (is_function_documentation(value)) {
            if (value.args &&
                this.getNumberOfArguments(value.args) > 0 &&
                shouldRenderParameters(this.intellisense_render_setting)) {
                el.createEl('p', { text: "Parameter list:" });
                const list = el.createEl("ol");
                for (const [key, val] of Object.entries(value.args)) {
                    append_bolded_label_with_value_to_parent(list, key, val.description);
                }
            }
            if (value.returns &&
                shouldRenderReturns(this.intellisense_render_setting)) {
                append_bolded_label_with_value_to_parent(el, 'Returns', value.returns);
            }
        }
        if (this.function_trigger && is_function_documentation(value)) {
            el.createEl("code", { text: value.definition });
        }
        if (value.description
            && shouldRenderDescription(this.intellisense_render_setting)) {
            el.createEl("div", { text: value.description });
        }
    }
    selectSuggestion(value, _evt) {
        const active_editor = this.app.workspace.activeEditor;
        if (!active_editor || !active_editor.editor) {
            // TODO: Error msg
            return;
        }
        active_editor.editor.replaceRange(value.queryKey, this.latest_trigger_info.start, this.latest_trigger_info.end);
        if (this.latest_trigger_info.start.ch == this.latest_trigger_info.end.ch) {
            // Dirty hack to prevent the cursor being at the
            // beginning of the word after completion,
            // Not sure what's the cause of this bug.
            const cursor_pos = this.latest_trigger_info.end;
            cursor_pos.ch += value.queryKey.length;
            active_editor.editor.setCursor(cursor_pos);
        }
    }
    getNumberOfArguments(args) {
        try {
            return new Map(Object.entries(args)).size;
        }
        catch (error) {
            return 0;
        }
    }
    updateAutocompleteIntellisenseSetting(value) {
        this.intellisense_render_setting = value;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXV0b2NvbXBsZXRlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2VkaXRvci9BdXRvY29tcGxldGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFHSCxhQUFhLEdBSWhCLE1BQU0sVUFBVSxDQUFDO0FBRWxCLE9BQU8sRUFDSCxhQUFhLEVBQ2IseUJBQXlCLEVBQ3pCLGNBQWMsR0FJakIsTUFBTSxtQkFBbUIsQ0FBQztBQUUzQixPQUFPLEVBRUgsdUJBQXVCLEVBQ3ZCLHNCQUFzQixFQUN0QixtQkFBbUIsRUFDdEIsTUFBTSxxREFBcUQsQ0FBQTtBQUc1RCxPQUFPLEVBQUUsd0NBQXdDLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFFdkUsTUFBTSxPQUFPLFlBQWEsU0FBUSxhQUFxQztJQVluRSxZQUFZLE1BQXVCO1FBQy9CLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7UUFadEIsNkJBQTZCO1FBQzdCLGtDQUFrQztRQUMxQixxQkFBZ0IsR0FDcEIsOERBQThELENBQUM7UUFVL0QsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUMvQyxJQUFJLENBQUMsMkJBQTJCLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQyxtQkFBbUIsQ0FBQTtJQUMxRSxDQUFDO0lBRUQsU0FBUyxDQUNMLE1BQXNCLEVBQ3RCLE1BQWMsRUFDZCxLQUFZO1FBRVosTUFBTSxLQUFLLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FDekIsRUFBRSxJQUFJLEVBQUUsTUFBTSxDQUFDLElBQUksRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLEVBQzVCLEVBQUUsSUFBSSxFQUFFLE1BQU0sQ0FBQyxJQUFJLEVBQUUsRUFBRSxFQUFFLE1BQU0sQ0FBQyxFQUFFLEVBQUUsQ0FDdkMsQ0FBQztRQUNGLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsS0FBSyxD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QUFDLG1CQUFtQixDQUFDLEdBQUcsQ0FDL0IsQ0FBQztRQUNGLElBQ0ksSUFBSSxDQUFDLG1CQUFtQixDQUFDLEtBQUssQ0FBQyxFQUFFLElBQUksSUFBSSxDQUFDLG1CQUFtQixDQUFDLEdBQUcsQ0FBQyxFQUFFLEVBQ3RFO1lBQ0UsZ0RBQWdEO1lBQ2hELDBDQUEwQztZQUMxQyx5Q0FBeUM7WUFDekMsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUFDLEdBQUcsQ0FBQztZQUNoRCxVQUFVLENBQUMsRUFBRSxJQUFJLEtBQUssQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDO1lBQ3ZDLGFBQWEsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1NBQzlDO0lBQ0wsQ0FBQztJQUVELG9CQUFvQixDQUNoQixJQUFZO1FBRVosSUFBSTtZQUNBLE9BQU8sSUFBSSxHQUFHLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztTQUM3QztRQUFDLE9BQU8sS0FBSyxFQUFFO1lBQ1osT0FBTyxDQUFDLENBQUM7U0FDWjtJQUNMLENBQUM7SUFFRCxxQ0FBcUMsQ0FBQyxLQUErQjtRQUNqRSxJQUFJLENBQUMsMkJBQTJCLEdBQUcsS0FBSyxDQUFDO0lBQzdDLENBQUM7Q0FDSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XHJcbiAgICBFZGl0b3IsXHJcbiAgICBFZGl0b3JQb3NpdGlvbixcclxuICAgIEVkaXRvclN1Z2dlc3QsXHJcbiAgICBFZGl0b3JTdWdnZXN0Q29udGV4dCxcclxuICAgIEVkaXRvclN1Z2dlc3RUcmlnZ2VySW5mbyxcclxuICAgIFRGaWxlLFxyXG59IGZyb20gXCJvYnNpZGlhblwiO1xyXG5cclxuaW1wb3J0IHtcclxuICAgIERvY3VtZW50YXRpb24sXHJcbiAgICBpc19mdW5jdGlvbl9kb2N1bWVudGF0aW9uLFxyXG4gICAgaXNfbW9kdWxlX25hbWUsXHJcbiAgICBNb2R1bGVOYW1lLFxyXG4gICAgVHBGdW5jdGlvbkRvY3VtZW50YXRpb24sXHJcbiAgICBUcFN1Z2dlc3REb2N1bWVudGF0aW9uLFxyXG59IGZyb20gXCIuL1RwRG9jdW1lbnRhdGlvblwiO1xyXG5cclxuaW1wb3J0IHtcclxuICAgIEludGVsbGlzZW5zZVJlbmRlck9wdGlvbixcclxuICAgIHNob3VsZFJlbmRlckRlc2NyaXB0aW9uLFxyXG4gICAgc2hvdWxkUmVuZGVyUGFyYW1ldGVycyxcclxuICAgIHNob3VsZFJlbmRlclJldHVybnNcclxufSBmcm9tIFwiLi4vc2V0dGluZ3MvUmVuZGVyU2V0dGluZ3MvSW50ZWxsaXNlbnNlUmVuZGVyT3B0aW9uXCJcclxuXHJcbmltcG9ydCBUZW1wbGF0ZXJQbHVnaW4gZnJvbSBcIm1haW5cIjtcclxuaW1wb3J0IHsgYXBwZW5kX2JvbGRlZF9sYWJlbF93aXRoX3ZhbHVlX3RvX3BhcmVudCB9IGZyb20gXCJ1dGlscy9VdGlsc1wiO1xyXG5cclxuZXhwb3J0IGNsYXNzIEF1dG9jb21wbGV0ZSBleHRlbmRzIEVkaXRvclN1Z2dlc3Q8VHBTdWdnZXN0RG9jdW1lbnRhdGlvbj4ge1xyXG4gICAgLy9wcml2YXRlIGluX2NvbW1hbmQgPSBmYWxzZTtcclxuICAgIC8vIGh0dHBzOi8vcmVnZXgxMDEuY29tL3Ivb2NtSHpSLzFcclxuICAgIHByaXZhdGUgdHBfa2V5d29yZF9yZWdleCA9XHJcbiAgICAgICAgL3RwXFwuKD88bW9kdWxlPlthLXpdKik/KD88Zm5fdHJpZ2dlcj5cXC4oPzxmbj5bYS16QS1aXy5dKik/KT8kLztcclxuICAgIHByaXZhdGUgZG9jdW1lbnRhdGlvbjogRG9jdW1lbnRhdGlvbjtcclxuICAgIHByaXZhdGUgbGF0ZXN0X3RyaWdnZXJfaW5mbzogRWRpdG9yU3VnZ2VzdFRyaWdnZXJJbmZvO1xyXG4gICAgcHJpdmF0ZSBtb2R1bGVfbmFtZTogTW9kdWxlTmFtZSB8IHN0cmluZztcclxuICAgIHByaXZhdGUgZnVuY3Rpb25fdHJpZ2dlcjogYm9vbGVhbjtcclxuICAgIHByaXZhdGUgZnVuY3Rpb25fbmFtZTogc3RyaW5nO1xyXG4gICAgcHJpdmF0ZSBpbnRlbGxpc2Vuc2VfcmVuZGVyX3NldHRpbmc6IEludGVsbGlzZW5zZVJlbmRlck9wdGlvblxyXG5cclxuICAgIGNvbnN0cnVjdG9yKHBsdWdpbjogVGVtcGxhdGVyUGx1Z2luKSB7XHJcbiAgICAgICAgc3VwZXIocGx1Z2luLmFwcCk7XHJcbiAgICAgICAgdGhpcy5kb2N1bWVudGF0aW9uID0gbmV3IERvY3VtZW50YXRpb24ocGx1Z2luKTtcclxuICAgICAgICB0aGlzLmludGVsbGlzZW5zZV9yZW5kZXJfc2V0dGluZyA9IHBsdWdpbi5zZXR0aW5ncy5pbnRlbGxpc2Vuc2VfcmVuZGVyXHJcbiAgICB9XHJcblxyXG4gICAgb25UcmlnZ2VyKFxyXG4gICAgICAgIGN1cnNvcjogRWRpdG9yUG9zaXRpb24sXHJcbiAgICAgICAgZWRpdG9yOiBFZGl0b3IsXHJcbiAgICAgICAgX2ZpbGU6IFRGaWxlXHJcbiAgICApOiBFZGl0b3JTdWdnZXN0VHJpZ2dlckluZm8gfCBudWxsIHtcclxuICAgICAgICBjb25zdCByYW5nZSA9IGVkaXRvci5nZXRSYW5nZShcclxuICAgICAgICAgICAgeyBsaW5lOiBjdXJzb3IubGluZSwgY2g6IDAgfSxcclxuICAgICAgICAgICAgeyBsaW5lOiBjdXJzb3IubGluZSwgY2g6IGN1cnNvci5jaCB9XHJcbiAgICAgICAgKTtcclxuICAgICAgICBjb25zdCBtYXRjaCA9IHRoaXMudHBfa2V5d29yZF9yZWdleC5leGVjKHJhbmdlKTtcclxuICAgICAgICBpZiAoIW1hdGNoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0IHF1ZXJ5OiBzdHJpbmc7XHJcbiAgICAgICAgY29uc3QgbW9kdWxlX25hbWUgPSAobWF0Y2guZ3JvdXBzICYmIG1hdGNoLmdyb3Vwc1tcIm1vZHVsZVwiXSkgfHwgXCJcIjtcclxuICAgICAgICB0aGlzLm1vZHVsZV9uYW1lID0gbW9kdWxlX25hbWU7XHJcblxyXG4gICAgICAgIGlmIChtYXRjaC5ncm91cHMgJiYgbWF0Y2guZ3JvdXBzW1wiZm5fdHJpZ2dlclwiXSkge1xyXG4gICAgICAgICAgICBpZiAobW9kdWxlX25hbWUgPT0gXCJcIiB8fCAhaXNfbW9kdWxlX25hbWUobW9kdWxlX25hbWUpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLmZ1bmN0aW9uX3RyaWdnZXIgPSB0cnVlO1xyXG4gICAgICAgICAgICB0aGlzLmZ1bmN0aW9uX25hbWUgPSBtYXRjaC5ncm91cHNbXCJmblwiXSB8fCBcIlwiO1xyXG4gICAgICAgICAgICBxdWVyeSA9IHRoaXMuZnVuY3Rpb25fbmFtZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmZ1bmN0aW9uX3RyaWdnZXIgPSBmYWxzZTtcclxuICAgICAgICAgICAgcXVlcnkgPSB0aGlzLm1vZHVsZV9uYW1lO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgdHJpZ2dlcl9pbmZvOiBFZGl0b3JTdWdnZXN0VHJpZ2dlckluZm8gPSB7XHJcbiAgICAgICAgICAgIHN0YXJ0OiB7IGxpbmU6IGN1cnNvci5saW5lLCBjaDogY3Vyc29yLmNoIC0gcXVlcnkubGVuZ3RoIH0sXHJcbiAgICAgICAgICAgIGVuZDogeyBsaW5lOiBjdXJzb3IubGluZSwgY2g6IGN1cnNvci5jaCB9LFxyXG4gICAgICAgICAgICBxdWVyeTogcXVlcnksXHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLmxhdGVzdF90cmlnZ2VyX2luZm8gPSB0cmlnZ2VyX2luZm87XHJcbiAgICAgICAgcmV0dXJuIHRyaWdnZXJfaW5mbztcclxuICAgIH1cclxuXHJcbiAgICBhc3luYyBnZXRTdWdnZXN0aW9ucyhjb250ZXh0OiBFZGl0b3JTdWdnZXN0Q29udGV4dCk6IFByb21pc2U8VHBTdWdnZXN0RG9jdW1lbnRhdGlvbltdPiB7XHJcbiAgICAgICAgbGV0IHN1Z2dlc3Rpb25zOiBBcnJheTxUcFN1Z2dlc3REb2N1bWVudGF0aW9uPjtcclxuICAgICAgICBpZiAodGhpcy5tb2R1bGVfbmFtZSAmJiB0aGlzLmZ1bmN0aW9uX3RyaWdnZXIpIHtcclxuICAgICAgICAgICAgc3VnZ2VzdGlvbnMgPSBhd2FpdCB0aGlzLmRvY3VtZW50YXRpb24uZ2V0X2FsbF9mdW5jdGlvbnNfZG9jdW1lbnRhdGlvbihcclxuICAgICAgICAgICAgICAgIHRoaXMubW9kdWxlX25hbWUgYXMgTW9kdWxlTmFtZSxcclxuICAgICAgICAgICAgICAgIHRoaXMuZnVuY3Rpb25fbmFtZVxyXG4gICAgICAgICAgICApIGFzIFRwRnVuY3Rpb25Eb2N1bWVudGF0aW9uW107XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgc3VnZ2VzdGlvbnMgPSB0aGlzLmRvY3VtZW50YXRpb24uZ2V0X2FsbF9tb2R1bGVzX2RvY3VtZW50YXRpb24oKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCFzdWdnZXN0aW9ucykge1xyXG4gICAgICAgICAgICByZXR1cm4gW107XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBzdWdnZXN0aW9ucy5maWx0ZXIoKHMpID0+XHJcbiAgICAgICAgICAgIHMucXVlcnlLZXkudG9Mb3dlckNhc2UoKS5zdGFydHNXaXRoKGNvbnRleHQucXVlcnkudG9Mb3dlckNhc2UoKSlcclxuICAgICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIHJlbmRlclN1Z2dlc3Rpb24odmFsdWU6IFRwU3VnZ2VzdERvY3VtZW50YXRpb24sIGVsOiBIVE1MRWxlbWVudCk6IHZvaWQge1xyXG4gICAgICAgIGVsLmNyZWF0ZUVsKFwiYlwiLCB7IHRleHQ6IHZhbHVlLm5hbWUgfSk7XHJcbiAgICAgICAgaWYgKGlzX2Z1bmN0aW9uX2RvY3VtZW50YXRpb24odmFsdWUpKVxyXG4gICAgICAgIHtcclxuICAgICAgICAgICAgaWYgKHZhbHVlLmFyZ3MgJiZcclxuICAgICAgICAgICAgICAgIHRoaXMuZ2V0TnVtYmVyT2ZBcmd1bWVudHModmFsdWUuYXJncykgPiAwICYmXHJcbiAgICAgICAgICAgICAgICBzaG91bGRSZW5kZXJQYXJhbWV0ZXJzKHRoaXMuaW50ZWxsaXNlbnNlX3JlbmRlcl9zZXR0aW5nKVxyXG4gICAgICAgICAgICApIHtcclxuICAgICAgICAgICAgICAgIGVsLmNyZWF0ZUVsKCdwJywge3RleHQ6IFwiUGFyYW1ldGVyIGxpc3Q6XCJ9KVxyXG4gICAgICAgICAgICAgICAgY29uc3QgbGlzdCA9IGVsLmNyZWF0ZUVsKFwib2xcIik7XHJcbiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IFtrZXksIHZhbF0gb2YgT2JqZWN0LmVudHJpZXModmFsdWUuYXJncykpIHtcclxuICAgICAgICAgICAgICAgICAgICBhcHBlbmRfYm9sZGVkX2xhYmVsX3dpdGhfdmFsdWVfdG9fcGFyZW50KGxpc3QsIGtleSwgdmFsLmRlc2NyaXB0aW9uKVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICh2YWx1ZS5yZXR1cm5zICYmXHJcbiAgICAgICAgICAgICAgICBzaG91bGRSZW5kZXJSZXR1cm5zKHRoaXMuaW50ZWxsaXNlbnNlX3JlbmRlcl9zZXR0aW5nKVxyXG4gICAgICAgICAgICApIHtcclxuICAgICAgICAgICAgICAgIGFwcGVuZF9ib2xkZWRfbGFiZWxfd2l0aF92YWx1ZV90b19wYXJlbnQoZWwsICdSZXR1cm5zJywgdmFsdWUucmV0dXJucylcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5mdW5jdGlvbl90cmlnZ2VyICYmIGlzX2Z1bmN0aW9uX2RvY3VtZW50YXRpb24odmFsdWUpKSB7XHJcbiAgICAgICAgICAgIGVsLmNyZWF0ZUVsKFwiY29kZVwiLCB7IHRleHQ6IHZhbHVlLmRlZmluaXRpb24gfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh2YWx1ZS5kZXNjcmlwdGlvblxyXG4gICAgICAgICAgICAmJiBzaG91bGRSZW5kZXJEZXNjcmlwdGlvbih0aGlzLmludGVsbGlzZW5zZV9yZW5kZXJfc2V0dGluZykpIHtcclxuICAgICAgICAgICAgZWwuY3JlYXRlRWwoXCJkaXZcIiwgeyB0ZXh0OiB2YWx1ZS5kZXNjcmlwdGlvbiB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgc2VsZWN0U3VnZ2VzdGlvbihcclxuICAgICAgICB2YWx1ZTogVHBTdWdnZXN0RG9jdW1lbnRhdGlvbixcclxuICAgICAgICBfZXZ0OiBNb3VzZUV2ZW50IHwgS2V5Ym9hcmRFdmVudFxyXG4gICAgKTogdm9pZCB7XHJcbiAgICAgICAgY29uc3QgYWN0aXZlX2VkaXRvciA9IHRoaXMuYXBwLndvcmtzcGFjZS5hY3RpdmVFZGl0b3I7XHJcbiAgICAgICAgaWYgKCFhY3RpdmVfZWRpdG9yIHx8ICFhY3RpdmVfZWRpdG9yLmVkaXRvcikge1xyXG4gICAgICAgICAgICAvLyBUT0RPOiBFcnJvciBtc2dcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBhY3RpdmVfZWRpdG9yLmVkaXRvci5yZXBsYWNlUmFuZ2UoXHJcbiAgICAgICAgICAgIHZhbHVlLnF1ZXJ5S2V5LFxyXG4gICAgICAgICAgICB0aGlzLmxhdGVzdF90cmlnZ2VyX2luZm8uc3RhcnQsXHJcbiAgICAgICAgICAgIHRoaXMubGF0ZXN0X3RyaWdnZXJfaW5mby5lbmRcclxuICAgICAgICApO1xyXG4gICAgICAgIGlmIChcclxuICAgICAgICAgICAgdGhpcy5sYXRlc3RfdHJpZ2dlcl9pbmZvLnN0YXJ0LmNoID09IHRoaXMubGF0ZXN0X3RyaWdnZXJfaW5mby5lbmQuY2hcclxuICAgICAgICApIHtcclxuICAgICAgICAgICAgLy8gRGlydHkgaGFjayB0byBwcmV2ZW50IHRoZSBjdXJzb3IgYmVpbmcgYXQgdGhlXHJcbiAgICAgICAgICAgIC8vIGJlZ2lubmluZyBvZiB0aGUgd29yZCBhZnRlciBjb21wbGV0aW9uLFxyXG4gICAgICAgICAgICAvLyBOb3Qgc3VyZSB3aGF0J3MgdGhlIGNhdXNlIG9mIHRoaXMgYnVnLlxyXG4gICAgICAgICAgICBjb25zdCBjdXJzb3JfcG9zID0gdGhpcy5sYXRlc3RfdHJpZ2dlcl9pbmZvLmVuZDtcclxuICAgICAgICAgICAgY3Vyc29yX3Bvcy5jaCArPSB2YWx1ZS5xdWVyeUtleS5sZW5ndGg7XHJcbiAgICAgICAgICAgIGFjdGl2ZV9lZGl0b3IuZWRpdG9yLnNldEN1cnNvcihjdXJzb3JfcG9zKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0TnVtYmVyT2ZBcmd1bWVudHMoXHJcbiAgICAgICAgYXJnczogb2JqZWN0XHJcbiAgICApOiBudW1iZXIge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIHJldHVybiBuZXcgTWFwKE9iamVjdC5lbnRyaWVzKGFyZ3MpKS5zaXplO1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgIHJldHVybiAwO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICB1cGRhdGVBdXRvY29tcGxldGVJbnRlbGxpc2Vuc2VTZXR0aW5nKHZhbHVlOiBJbnRlbGxpc2Vuc2VSZW5kZXJPcHRpb24pe1xyXG4gICAgICAgIHRoaXMuaW50ZWxsaXNlbnNlX3JlbmRlcl9zZXR0aW5nID0gdmFsdWU7XHJcbiAgICB9XHJcbn1cclxuIl19