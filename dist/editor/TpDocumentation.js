import { __awaiter } from "tslib";
import { errorWrapper } from "utils/Error";
import { get_fn_params, get_tfiles_from_folder, is_object, populate_docs_from_user_scripts } from "utils/Utils";
import documentation from "../../docs/documentation.toml";
const module_names = [
    "app",
    "config",
    "date",
    "file",
    "frontmatter",
    "hooks",
    "obsidian",
    "system",
    "user",
    "web",
];
const module_names_checker = new Set(module_names);
export function is_module_name(x) {
    return typeof x === "string" && module_names_checker.has(x);
}
export function is_function_documentation(x) {
    if (x.definition ||
        x.returns ||
        x.args) {
        return true;
    }
    return false;
}
export class Documentation {
    constructor(plugin) {
        this.plugin = plugin;
        this.documentation = documentation;
    }
    get_all_modules_documentation() {
        let tp = this.documentation.tp;
        // Remove 'user' if no user scripts found
        if (!this.plugin.settings ||
            !this.plugin.settings.user_scripts_folder) {
            tp = Object.values(tp).filter((x) => x.name !== 'user');
        }
        return Object.values(tp).map((mod) => {
            mod.queryKey = mod.name;
            return mod;
        });
    }
    get_all_functions_documentation(module_name, function_name) {
        return __awaiter(this, void 0, void 0, function* () {
            if (module_name === "app") {
                return this.get_app_functions_documentation(this.plugin.app, function_name);
            }
            if (module_name === "user") {
                if (!this.plugin.settings ||
                    !this.plugin.settings.user_scripts_folder)
                    return;
                const files = yield errorWrapper(() => __awaiter(this, void 0, void 0, function* () {
                    const files = get_tfiles_from_folder(this.plugin.app, this.plugin.settings.user_scripts_folder).filter(x => x.extension == "js");
                    const docFiles = yield populate_docs_from_user_scripts(this.plugin.app, files);
                    return docFiles;
                }), `User Scripts folder doesn't exist`);
                if (!files || files.length === 0)
                    return;
                return files.reduce((processedFiles, file) => {
                    if (file.extension !== "js")
                        return processedFiles;
                    const values = [
                        ...processedFiles,
                        {
                            name: file.basename,
                            queryKey: file.basename,
                            definition: "",
                            description: file.description,
                            returns: file.returns,
                            args: file.arguments.reduce((acc, arg) => {
                                acc[arg.name] = {
                                    name: arg.name,
                                    description: arg.description
                                };
                                return acc;
                            }, {}),
                            example: "",
                        },
                    ];
                    return values;
                }, []);
            }
            if (!this.documentation.tp[module_name].functions) {
                return;
            }
            return Object.values(this.documentation.tp[module_name].functions).map((mod) => {
                mod.queryKey = mod.name;
                return mod;
            });
        });
    }
    get_app_functions_documentation(obj, path) {
        if (!is_object(obj)) {
            return [];
        }
        const parts = path.split(".");
        if (parts.length === 0) {
            return [];
        }
        let currentObj = obj;
        for (let index = 0; index < parts.length - 1; index++) {
            const part = parts[index];
            if (part in currentObj) {
                if (!is_object(currentObj[part])) {
                    return [];
                }
                currentObj = currentObj[part];
            }
        }
        const definitionPrefix = [
            "tp",
            "app",
            ...parts.slice(0, parts.length - 1),
        ].join(".");
        const queryKeyPrefix = parts.slice(0, parts.length - 1).join(".");
        const docs = [];
        for (const key in currentObj) {
            const definition = `${definitionPrefix}.${key}`;
            const queryKey = queryKeyPrefix ? `${queryKeyPrefix}.${key}` : key;
            docs.push({
                name: key,
                queryKey,
                definition: typeof currentObj[key] === "function"
                    ? `${definition}(${get_fn_params(currentObj[key])})`
                    : definition,
                description: "",
                returns: "",
                example: "",
            });
        }
        return docs;
    }
    get_module_documentation(module_name) {
        return this.documentation.tp[module_name];
    }
    get_function_documentation(module_name, function_name) {
        return this.documentation.tp[module_name].functions[function_name];
    }
    get_argument_documentation(module_name, function_name, argument_name) {
        const function_doc = this.get_function_documentation(module_name, function_name);
        if (!function_doc || !function_doc.args) {
            return null;
        }
        return function_doc.args[argument_name];
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVHBEb2N1bWVudGF0aW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2VkaXRvci9UcERvY3VtZW50YXRpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUNBLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDM0MsT0FBTyxFQUFFLGFBQWEsRUFBRSxzQkFBc0IsRUFBRSxTQUFTLEVBQUUsK0JBQStCLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDaEgsT0FBTyxhQUFhLE1BQU0sK0JBQStCLENBQUM7QUFFMUQsTUFBTSxZQUFZLEdBQUc7SUFDakIsS0FBSztJQUNMLFFBQVE7SUFDUixNQUFNO0lBQ04sTUFBTTtJQUNOLGFBQWE7SUFDYixPQUFPO0lBQ1AsVUFBVTtJQUNWLFFBQVE7SUFDUixNQUFNO0lBQ04sS0FBSztDQUNDLENBQUM7QUFFWCxNQUFNLG9CQUFvQixHQUFnQixJQUFJLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUVoRSxNQUFNLFVBQVUsY0FBYyxDQUFDLENBQVU7SUFDckMsT0FBTyxPQUFPLENBQUMsS0FBSyxRQUFRLElBQUksb0JBQW9CLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ2hFLENBQUM7QUF1Q0QsTUFBTSxVQUFVLHlCQUF5QixDQUNyQyxDQUF5QjtJQUV6QixJQUFLLENBQTZCLENBQUMsVUFBVTtRQUN4QyxDQUE2QixDQUFDLE9BQU87UUFDckMsQ0FBNkIsQ0FBQyxJQUFJLEVBQUU7UUFDckMsT0FBTyxJQUFJLENBQUM7S0FDZjtJQUNELE9BQU8sS0FBSyxDQUFDO0FBQ2pCLENBQUM7QUFFRCxNQUFNLE9BQU8sYUFBYTtJQUd0QixZQUFvQixNQUF1QjtRQUF2QixXQUFNLEdBQU4sTUFBTSxDQUFpQjtRQUZwQyxrQkFBYSxHQUFvQixhQUFhLENBQUM7SUFFUixDQUFDO0lBRS9DLDZCQUE2QjtRQUN6QixJQUFJLEVBQUUsR0FBRyxJQUFJLENBQUMsYUFBYSxD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QUFDLEVBQUUsQ0FBQyxXQUFXLENBQUMsQ0FBQyxTQUFTLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDdkUsQ0FBQztJQUVELDBCQUEwQixDQUN0QixXQUF1QixFQUN2QixhQUFxQixFQUNyQixhQUFxQjtRQUVyQixNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsMEJBQTBCLENBQ2hELFdBQVcsRUFDWCxhQUFhLENBQ2hCLENBQUM7UUFDRixJQUFJLENBQUMsWUFBWSxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRTtZQUNyQyxPQUFPLElBQUksQ0FBQztTQUNmO1FBQ0QsT0FBTyxZQUFZLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQzVDLENBQUM7Q0FDSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBUZW1wbGF0ZXJQbHVnaW4gZnJvbSBcIm1haW5cIjtcclxuaW1wb3J0IHsgZXJyb3JXcmFwcGVyIH0gZnJvbSBcInV0aWxzL0Vycm9yXCI7XHJcbmltcG9ydCB7IGdldF9mbl9wYXJhbXMsIGdldF90ZmlsZXNfZnJvbV9mb2xkZXIsIGlzX29iamVjdCwgcG9wdWxhdGVfZG9jc19mcm9tX3VzZXJfc2NyaXB0cyB9IGZyb20gXCJ1dGlscy9VdGlsc1wiO1xyXG5pbXBvcnQgZG9jdW1lbnRhdGlvbiBmcm9tIFwiLi4vLi4vZG9jcy9kb2N1bWVudGF0aW9uLnRvbWxcIjtcclxuXHJcbmNvbnN0IG1vZHVsZV9uYW1lcyA9IFtcclxuICAgIFwiYXBwXCIsXHJcbiAgICBcImNvbmZpZ1wiLFxyXG4gICAgXCJkYXRlXCIsXHJcbiAgICBcImZpbGVcIixcclxuICAgIFwiZnJvbnRtYXR0ZXJcIixcclxuICAgIFwiaG9va3NcIixcclxuICAgIFwib2JzaWRpYW5cIixcclxuICAgIFwic3lzdGVtXCIsXHJcbiAgICBcInVzZXJcIixcclxuICAgIFwid2ViXCIsXHJcbl0gYXMgY29uc3Q7XHJcbmV4cG9ydCB0eXBlIE1vZHVsZU5hbWUgPSAodHlwZW9mIG1vZHVsZV9uYW1lcylbbnVtYmVyXTtcclxuY29uc3QgbW9kdWxlX25hbWVzX2NoZWNrZXI6IFNldDxzdHJpbmc+ID0gbmV3IFNldChtb2R1bGVfbmFtZXMpO1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGlzX21vZHVsZV9uYW1lKHg6IHVua25vd24pOiB4IGlzIE1vZHVsZU5hbWUge1xyXG4gICAgcmV0dXJuIHR5cGVvZiB4ID09PSBcInN0cmluZ1wiICYmIG1vZHVsZV9uYW1lc19jaGVja2VyLmhhcyh4KTtcclxufVxyXG5cclxuZXhwb3J0IHR5cGUgVHBEb2N1bWVudGF0aW9uID0ge1xyXG4gICAgdHA6IHtcclxuICAgICAgICBba2V5IGluIE1vZHVsZU5hbWVdOiBUcE1vZHVsZURvY3VtZW50YXRpb247XHJcbiAgICB9O1xyXG59O1xyXG5cclxuZXhwb3J0IHR5cGUgVHBNb2R1bGVEb2N1bWVudGF0aW9uID0ge1xyXG4gICAgbmFtZTogc3RyaW5nO1xyXG4gICAgcXVlcnlLZXk6IHN0cmluZztcclxuICAgIGRlc2NyaXB0aW9uOiBzdHJpbmc7XHJcbiAgICBmdW5jdGlvbnM6IHtcclxuICAgICAgICBba2V5OiBzdHJpbmddOiBUcEZ1bmN0aW9uRG9jdW1lbnRhdGlvbjtcclxuICAgIH07XHJcbn07XHJcblxyXG5leHBvcnQgdHlwZSBUcEZ1bmN0aW9uRG9jdW1lbnRhdGlvbiA9IHtcclxuICAgIG5hbWU6IHN0cmluZztcclxuICAgIHF1ZXJ5S2V5OiBzdHJpbmc7XHJcbiAgICBkZWZpbml0aW9uOiBzdHJpbmc7XHJcbiAgICBkZXNjcmlwdGlvbjogc3RyaW5nO1xyXG4gICAgcmV0dXJuczogc3RyaW5nO1xyXG4gICAgZXhhbXBsZTogc3RyaW5nO1xyXG4gICAgYXJncz86IHtcclxuICAgICAgICBba2V5OiBzdHJpbmddOiBUcEFyZ3VtZW50RG9jdW1lbnRhdGlvbjtcclxuICAgIH07XHJcbn07XHJcblxyXG5leHBvcnQgdHlwZSBUcEFyZ3VtZW50RG9jdW1lbnRhdGlvbiA9IHtcclxuICAgIG5hbWU6IHN0cmluZztcclxuICAgIGRlc2NyaXB0aW9uOiBzdHJpbmc7XHJcbn07XHJcblxyXG5leHBvcnQgdHlwZSBUcFN1Z2dlc3REb2N1bWVudGF0aW9uID1cclxuICAgIHwgVHBNb2R1bGVEb2N1bWVudGF0aW9uXHJcbiAgICB8IFRwRnVuY3Rpb25Eb2N1bWVudGF0aW9uXHJcbiAgICB8IFRwQXJndW1lbnREb2N1bWVudGF0aW9uO1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGlzX2Z1bmN0aW9uX2RvY3VtZW50YXRpb24oXHJcbiAgICB4OiBUcFN1Z2dlc3REb2N1bWVudGF0aW9uXHJcbik6IHggaXMgVHBGdW5jdGlvbkRvY3VtZW50YXRpb24ge1xyXG4gICAgaWYgKCh4IGFzIFRwRnVuY3Rpb25Eb2N1bWVudGF0aW9uKS5kZWZpbml0aW9uIHx8XHJcbiAgICAgICAgKHggYXMgVHBGdW5jdGlvbkRvY3VtZW50YXRpb24pLnJldHVybnMgfHxcclxuICAgICAgICAoeCBhcyBUcEZ1bmN0aW9uRG9jdW1lbnRhdGlvbikuYXJncykge1xyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgRG9jdW1lbnRhdGlvbiB7XHJcbiAgICBwdWJsaWMgZG9jdW1lbnRhdGlvbjogVHBEb2N1bWVudGF0aW9uID0gZG9jdW1lbnRhdGlvbjtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHBsdWdpbjogVGVtcGxhdGVyUGx1Z2luKSB7fVxyXG5cclxuICAgIGdldF9hbGxfbW9kdWxlc19kb2N1bWVudGF0aW9uKCk6IFRwTW9kdWxlRG9jdW1lbnRhdGlvbltdIHtcclxuICAgICAgICBsZXQgdHAgPSB0aGlzLmRvY3VtZW50YXRpb24udHBcclxuXHJcbiAgICAgICAgLy8gUmVtb3ZlICd1c2VyJyBpZiBubyB1c2VyIHNjcmlwdHMgZm91bmRcclxuICAgICAgICBpZiAoIXRoaXMucGx1Z2luLnNldHRpbmdzIHx8XHJcbiAgICAgICAgICAgICF0aGlzLnBsdWdpbi5zZXR0aW5ncy51c2VyX3NjcmlwdHNfZm9sZGVyKSB7XHJcbiAgICAgICAgICAgIHRwID0gT2JqZWN0LnZhbHVlcyh0cCkuZmlsdGVyKCh4KSA9PiB4Lm5hbWUgIT09ICd1c2VyJylcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBPYmplY3QudmFsdWVzKHRwKS5tYXAoKG1vZCkgPT4ge1xyXG4gICAgICAgICAgICBtb2QucXVlcnlLZXkgPSBtb2QubmFtZTtcclxuICAgICAgICAgICAgcmV0dXJuIG1vZDtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBhc3luYyBnZXRfYWxsX2Z1bmN0aW9uc19kb2N1bWVudGF0aW9uKFxyXG4gICAgICAgIG1vZHVsZV9uYW1lOiBNb2R1bGVOYW1lLFxyXG4gICAgICAgIGZ1bmN0aW9uX25hbWU6IHN0cmluZ1xyXG4gICAgKTogUHJvbWlzZTxUcEZ1bmN0aW9uRG9jdW1lbnRhdGlvbltdIHwgdW5kZWZpbmVkPiB7XHJcbiAgICAgICAgaWYgKG1vZHVsZV9uYW1lID09PSBcImFwcFwiKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldF9hcHBfZnVuY3Rpb25zX2RvY3VtZW50YXRpb24oXHJcbiAgICAgICAgICAgICAgICB0aGlzLnBsdWdpbi5hcHAsXHJcbiAgICAgICAgICAgICAgICBmdW5jdGlvbl9uYW1lXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChtb2R1bGVfbmFtZSA9PT0gXCJ1c2VyXCIpIHtcclxuICAgICAgICAgICAgaWYgKFxyXG4gICAgICAgICAgICAgICAgIXRoaXMucGx1Z2luLnNldHRpbmdzIHx8XHJcbiAgICAgICAgICAgICAgICAhdGhpcy5wbHVnaW4uc2V0dGluZ3MudXNlcl9zY3JpcHRzX2ZvbGRlclxyXG4gICAgICAgICAgICApXHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIGNvbnN0IGZpbGVzID0gYXdhaXQgZXJyb3JXcmFwcGVyKFxyXG4gICAgICAgICAgICAgICAgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGZpbGVzID0gZ2V0X3RmaWxlc19mcm9tX2ZvbGRlcihcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wbHVnaW4uYXBwLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBsdWdpbi5zZXR0aW5ncy51c2VyX3NjcmlwdHNfZm9sZGVyXHJcbiAgICAgICAgICAgICAgICAgICAgKS5maWx0ZXIoeCA9PiB4LmV4dGVuc2lvbiA9PSBcImpzXCIpXHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZG9jRmlsZXMgPSBhd2FpdCBwb3B1bGF0ZV9kb2NzX2Zyb21fdXNlcl9zY3JpcHRzKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBsdWdpbi5hcHAsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVzXHJcbiAgICAgICAgICAgICAgICAgICAgKVxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBkb2NGaWxlcztcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBgVXNlciBTY3JpcHRzIGZvbGRlciBkb2Vzbid0IGV4aXN0YFxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgICAgICBpZiAoIWZpbGVzIHx8IGZpbGVzLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xyXG4gICAgICAgICAgICByZXR1cm4gZmlsZXMucmVkdWNlPFRwRnVuY3Rpb25Eb2N1bWVudGF0aW9uW10+KFxyXG4gICAgICAgICAgICAgICAgKHByb2Nlc3NlZEZpbGVzLCBmaWxlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZpbGUuZXh0ZW5zaW9uICE9PSBcImpzXCIpIHJldHVybiBwcm9jZXNzZWRGaWxlcztcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZXMgPSBbXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC4uLnByb2Nlc3NlZEZpbGVzLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiBmaWxlLmJhc2VuYW1lLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcXVlcnlLZXk6IGZpbGUuYmFzZW5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWZpbml0aW9uOiBcIlwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IGZpbGUuZGVzY3JpcHRpb24sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm5zOiBmaWxlLnJldHVybnMsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdzOiBmaWxlLmFyZ3VtZW50cy5yZWR1Y2U8e1trZXk6IHN0cmluZ106IFRwQXJndW1lbnREb2N1bWVudGF0aW9ufT4oKGFjYywgYXJnKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjW2FyZy5uYW1lXSA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogYXJnLm5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBhcmcuZGVzY3JpcHRpb25cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhY2M7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCB7fSksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGFtcGxlOiBcIlwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIF07XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlcztcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBbXVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoIXRoaXMuZG9jdW1lbnRhdGlvbi50cFttb2R1bGVfbmFtZV0uZnVuY3Rpb25zKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIE9iamVjdC52YWx1ZXModGhpcy5kb2N1bWVudGF0aW9uLnRwW21vZHVsZV9uYW1lXS5mdW5jdGlvbnMpLm1hcChcclxuICAgICAgICAgICAgKG1vZCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgbW9kLnF1ZXJ5S2V5ID0gbW9kLm5hbWU7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbW9kO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldF9hcHBfZnVuY3Rpb25zX2RvY3VtZW50YXRpb24oXHJcbiAgICAgICAgb2JqOiB1bmtub3duLFxyXG4gICAgICAgIHBhdGg6IHN0cmluZ1xyXG4gICAgKTogVHBGdW5jdGlvbkRvY3VtZW50YXRpb25bXSB7XHJcbiAgICAgICAgaWYgKCFpc19vYmplY3Qob2JqKSkge1xyXG4gICAgICAgICAgICByZXR1cm4gW107XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHBhcnRzID0gcGF0aC5zcGxpdChcIi5cIik7XHJcbiAgICAgICAgaWYgKHBhcnRzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICByZXR1cm4gW107XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgY3VycmVudE9iaiA9IG9iajtcclxuICAgICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgcGFydHMubGVuZ3RoIC0gMTsgaW5kZXgrKykge1xyXG4gICAgICAgICAgICBjb25zdCBwYXJ0ID0gcGFydHNbaW5kZXhdO1xyXG4gICAgICAgICAgICBpZiAocGFydCBpbiBjdXJyZW50T2JqKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWlzX29iamVjdChjdXJyZW50T2JqW3BhcnRdKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBbXTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGN1cnJlbnRPYmogPSBjdXJyZW50T2JqW3BhcnRdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBkZWZpbml0aW9uUHJlZml4ID0gW1xyXG4gICAgICAgICAgICBcInRwXCIsXHJcbiAgICAgICAgICAgIFwiYXBwXCIsXHJcbiAgICAgICAgICAgIC4uLnBhcnRzLnNsaWNlKDAsIHBhcnRzLmxlbmd0aCAtIDEpLFxyXG4gICAgICAgIF0uam9pbihcIi5cIik7XHJcbiAgICAgICAgY29uc3QgcXVlcnlLZXlQcmVmaXggPSBwYXJ0cy5zbGljZSgwLCBwYXJ0cy5sZW5ndGggLSAxKS5qb2luKFwiLlwiKTtcclxuICAgICAgICBjb25zdCBkb2NzOiBUcEZ1bmN0aW9uRG9jdW1lbnRhdGlvbltdID0gW107XHJcbiAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gY3VycmVudE9iaikge1xyXG4gICAgICAgICAgICBjb25zdCBkZWZpbml0aW9uID0gYCR7ZGVmaW5pdGlvblByZWZpeH0uJHtrZXl9YDtcclxuICAgICAgICAgICAgY29uc3QgcXVlcnlLZXkgPSBxdWVyeUtleVByZWZpeCA/IGAke3F1ZXJ5S2V5UHJlZml4fS4ke2tleX1gIDoga2V5O1xyXG4gICAgICAgICAgICBkb2NzLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgbmFtZToga2V5LFxyXG4gICAgICAgICAgICAgICAgcXVlcnlLZXksXHJcbiAgICAgICAgICAgICAgICBkZWZpbml0aW9uOlxyXG4gICAgICAgICAgICAgICAgICAgIHR5cGVvZiBjdXJyZW50T2JqW2tleV0gPT09IFwiZnVuY3Rpb25cIlxyXG4gICAgICAgICAgICAgICAgICAgICAgICA/IGAke2RlZmluaXRpb259KCR7Z2V0X2ZuX3BhcmFtcyhcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudE9ialtrZXldIGFzICguLi5hcmdzOiB1bmtub3duW10pID0+IHVua25vd25cclxuICAgICAgICAgICAgICAgICAgICAgICAgICApfSlgXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIDogZGVmaW5pdGlvbixcclxuICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBcIlwiLFxyXG4gICAgICAgICAgICAgICAgcmV0dXJuczogXCJcIixcclxuICAgICAgICAgICAgICAgIGV4YW1wbGU6IFwiXCIsXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIGRvY3M7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0X21vZHVsZV9kb2N1bWVudGF0aW9uKG1vZHVsZV9uYW1lOiBNb2R1bGVOYW1lKTogVHBNb2R1bGVEb2N1bWVudGF0aW9uIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5kb2N1bWVudGF0aW9uLnRwW21vZHVsZV9uYW1lXTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRfZnVuY3Rpb25fZG9jdW1lbnRhdGlvbihcclxuICAgICAgICBtb2R1bGVfbmFtZTogTW9kdWxlTmFtZSxcclxuICAgICAgICBmdW5jdGlvbl9uYW1lOiBzdHJpbmdcclxuICAgICk6IFRwRnVuY3Rpb25Eb2N1bWVudGF0aW9uIHwgbnVsbCB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZG9jdW1lbnRhdGlvbi50cFttb2R1bGVfbmFtZV0uZnVuY3Rpb25zW2Z1bmN0aW9uX25hbWVdO1xyXG4gICAgfVxyXG5cclxuICAgIGdldF9hcmd1bWVudF9kb2N1bWVudGF0aW9uKFxyXG4gICAgICAgIG1vZHVsZV9uYW1lOiBNb2R1bGVOYW1lLFxyXG4gICAgICAgIGZ1bmN0aW9uX25hbWU6IHN0cmluZyxcclxuICAgICAgICBhcmd1bWVudF9uYW1lOiBzdHJpbmdcclxuICAgICk6IFRwQXJndW1lbnREb2N1bWVudGF0aW9uIHwgbnVsbCB7XHJcbiAgICAgICAgY29uc3QgZnVuY3Rpb25fZG9jID0gdGhpcy5nZXRfZnVuY3Rpb25fZG9jdW1lbnRhdGlvbihcclxuICAgICAgICAgICAgbW9kdWxlX25hbWUsXHJcbiAgICAgICAgICAgIGZ1bmN0aW9uX25hbWVcclxuICAgICAgICApO1xyXG4gICAgICAgIGlmICghZnVuY3Rpb25fZG9jIHx8ICFmdW5jdGlvbl9kb2MuYXJncykge1xyXG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uX2RvYy5hcmdzW2FyZ3VtZW50X25hbWVdO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==