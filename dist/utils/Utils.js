import { __awaiter } from "tslib";
import { DocPlainText, TSDocParser } from "@microsoft/tsdoc";
import { TJDocFile, TJDocFileArgument } from "./TJDocFile";
import { TemplaterError } from "./Error";
import { normalizePath, TFile, TFolder, Vault, } from "obsidian";
export function delay(ms) {
    return new Promise((resolve) => setTimeout(resolve, ms));
}
export function escape_RegExp(str) {
    return str.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"); // $& means the whole matched string
}
export function generate_command_regex() {
    return /<%(?:-|_)?\s*[*~]{0,1}((?:.|\s)*?)(?:-|_)?%>/g;
}
export function generate_dynamic_command_regex() {
    return /(<%(?:-|_)?\s*[*~]{0,1})\+((?:.|\s)*?%>)/g;
}
export function resolve_tfolder(app, folder_str) {
    folder_str = normalizePath(folder_str);
    const folder = app.vault.getAbstractFileByPath(folder_str);
    if (!folder) {
        throw new TemplaterError(`Folder "${folder_str}" doesn't exist`);
    }
    if (!(folder instanceof TFolder)) {
        throw new TemplaterError(`${folder_str} is a file, not a folder`);
    }
    return folder;
}
export function resolve_tfile(app, file_str) {
    file_str = normalizePath(file_str);
    const file = app.vault.getAbstractFileByPath(file_str);
    if (!file) {
        throw new TemplaterError(`File "${file_str}" doesn't exist`);
    }
    if (!(file instanceof TFile)) {
        throw new TemplaterError(`${file_str} is a folder, not a file`);
    }
    return file;
}
export function get_tfiles_from_folder(app, folder_str) {
    const folder = resolve_tfolder(app, folder_str);
    const files = [];
    Vault.recurseChildren(folder, (file) => {
        if (file instanceof TFile) {
            files.push(file);
        }
    });
    files.sort((a, b) => {
        return a.path.localeCompare(b.path);
    });
    return files;
}
export function populate_docs_from_user_scripts(app, files) {
    return __awaiter(this, void 0, void 0, function* () {
        const docFiles = yield Promise.all(files.map((file) => __awaiter(this, void 0, void 0, function* () {
            // Get file contents
            const content = yield app.vault.cachedRead(file);
            const newDocFile = generate_jsdoc(file, content);
            return newDocFile;
        })));
        return docFiles;
    });
}
function generate_jsdoc(file, content) {
    // Parse the content
    const tsdocParser = new TSDocParser();
    const parsedDoc = tsdocParser.parseString(content);
    // Copy and extract information into the TJDocFile
    const newDocFile = new TJDocFile(file);
    newDocFile.description = generate_jsdoc_description(parsedDoc.docComment.summarySection);
    newDocFile.returns = generate_jsdoc_return(parsedDoc.docComment.returnsBlock);
    newDocFile.arguments = generate_jsdoc_arguments(parsedDoc.docComment.params);
    return newDocFile;
}
function generate_jsdoc_description(summarySection) {
    try {
        const description = summarySection.nodes.map((node) => node.getChildNodes()
            .filter((node) => node instanceof DocPlainText)
            .map((x) => x.text)
            .join("\n"));
        return description.join("\n");
    }
    catch (error) {
        console.error('Failed to parse sumamry section');
        throw error;
    }
}
function generate_jsdoc_return(returnSection) {
    if (!returnSection)
        return "";
    try {
        const returnValue = returnSection.content.nodes[0].getChildNodes()[0].text.trim();
        return returnValue;
    }
    catch (error) {
        return "";
    }
}
function generate_jsdoc_arguments(paramSection) {
    try {
        const blocks = paramSection.blocks;
        const args = blocks.map((block) => {
            const name = block.parameterName;
            const description = block.content.getChildNodes()[0].getChildNodes()
                .filter(x => x instanceof DocPlainText)
                .map(x => x.text).join(" ");
            return new TJDocFileArgument(name, description);
        });
        return args;
    }
    catch (error) {
        return [];
    }
}
export function arraymove(arr, fromIndex, toIndex) {
    if (toIndex < 0 || toIndex === arr.length) {
        return;
    }
    const element = arr[fromIndex];
    arr[fromIndex] = arr[toIndex];
    arr[toIndex] = element;
}
export function get_active_file(app) {
    var _a, _b;
    return (_b = (_a = app.workspace.activeEditor) === null || _a === void 0 ? void 0 : _a.file) !== null && _b !== void 0 ? _b : app.workspace.getActiveFile();
}
/**
 * @param path Normalized file path
 * @returns Folder path
 * @example
 * get_folder_path_from_path(normalizePath("path/to/folder/file", "md")) // path/to/folder
 */
export function get_folder_path_from_file_path(path) {
    const path_separator = path.lastIndexOf("/");
    if (path_separator !== -1)
        return path.slice(0, path_separator);
    return "";
}
export function is_object(obj) {
    return obj !== null && typeof obj === "object";
}
export function get_fn_params(func) {
    const str = func.toString();
    const len = str.indexOf("(");
    return str
        .substring(len + 1, str.indexOf(")"))
        .replace(/ /g, "")
        .split(",");
}
/**
 * Use a parent HtmlElement to create a label with a value
 * @param parent The parent HtmlElement; Use HtmlOListElement to return a `li` element
 * @param title The title for the label which will be bolded
 * @param value The value of the label
 * @returns A label HtmlElement (p | li)
 */
export function append_bolded_label_with_value_to_parent(parent, title, value) {
    const tag = parent instanceof HTMLOListElement ? "li" : "p";
    const para = parent.createEl(tag);
    const bold = parent.createEl('b', { text: title });
    para.appendChild(bold);
    para.appendChild(document.createTextNode(`: ${value}`));
    // Returns a p or li element
    // Resulting in <b>Title</b>: value
    return para;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdXRpbHMvVXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBd0QsWUFBWSxFQUE2QixXQUFXLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUU5SSxPQUFPLEVBQUUsU0FBUyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRTNELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFDekMsT0FBTyxFQUVILGFBQWEsRUFFYixLQUFLLEVBQ0wsT0FBTyxFQUNQLEtBQUssR0FDUixNQUFNLFVBQVUsQ0FBQztBQUVsQixNQUFNLFVBQVUsS0FBSyxDQUFDLEVBQVU7SUFDNUIsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDO0FBQzdELENBQUM7QUFFRCxNQUFNLFVBQVUsYUFBYSxDQUFDLEdBQVc7SUFDckMsT0FBTyxHQUFHLENBQUMsT0FBTyxDQUFDLHFCQUFxQixFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUMsb0NBQW9DO0FBQzNGLENBQUM7QUFFRCxNQUFNLFVBQVUsc0JBQXNCO0lBQ2xDLE9BQU8sK0NBQStDLENBQUM7QUFDM0QsQ0FBQztBQUVELE1BQU0sVUFBVSw4QkFBOEI7SUFDMUMsT0FBTywyQ0FBMkMsQ0FBQztBQUN2RCxDQUFDO0FBRUQsTUFBTSxVQUFVLGVBQWUsQ0FBQyxHQUFRLEVBQUUsVUFBa0I7SUFDeEQsVUFBVSxHQUFHLGFBQWEsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUV2QyxNQUFNLE1BQU0sR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLHFCQUFxQixDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQzNELElBQUksQ0FBQyxNQUFNLEVBQUU7UUFDVCxNQUFNLElBQUksY0FBYyxDQUFDLFdBQVcsVUFBVSxpQkFB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LENBQUMsS0FBSyxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUE7SUFFdkQsNEJBQTRCO0lBQzVCLG1DQUFtQztJQUNuQyxPQUFPLElBQUksQ0FBQztBQUNoQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRG9jQmxvY2ssIERvY05vZGUsIERvY1BhcmFtQmxvY2ssIERvY1BhcmFtQ29sbGVjdGlvbiwgRG9jUGxhaW5UZXh0LCBEb2NTZWN0aW9uLCBQYXJzZXJDb250ZXh0LCBUU0RvY1BhcnNlciB9IGZyb20gXCJAbWljcm9zb2Z0L3RzZG9jXCI7XHJcblxyXG5pbXBvcnQgeyBUSkRvY0ZpbGUsIFRKRG9jRmlsZUFyZ3VtZW50IH0gZnJvbSBcIi4vVEpEb2NGaWxlXCI7XHJcblxyXG5pbXBvcnQgeyBUZW1wbGF0ZXJFcnJvciB9IGZyb20gXCIuL0Vycm9yXCI7XHJcbmltcG9ydCB7XHJcbiAgICBBcHAsXHJcbiAgICBub3JtYWxpemVQYXRoLFxyXG4gICAgVEFic3RyYWN0RmlsZSxcclxuICAgIFRGaWxlLFxyXG4gICAgVEZvbGRlcixcclxuICAgIFZhdWx0LFxyXG59IGZyb20gXCJvYnNpZGlhblwiO1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGRlbGF5KG1zOiBudW1iZXIpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gc2V0VGltZW91dChyZXNvbHZlLCBtcykpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZXNjYXBlX1JlZ0V4cChzdHI6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gc3RyLnJlcGxhY2UoL1suKis/XiR7fSgpfFtcXF1cXFxcXS9nLCBcIlxcXFwkJlwiKTsgLy8gJCYgbWVhbnMgdGhlIHdob2xlIG1hdGNoZWQgc3RyaW5nXHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZW5lcmF0ZV9jb21tYW5kX3JlZ2V4KCk6IFJlZ0V4cCB7XHJcbiAgICByZXR1cm4gLzwlKD86LXxfKT9cXHMqWyp+XXswLDF9KCg/Oi58XFxzKSo/KSg/Oi18Xyk/JT4vZztcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdlbmVyYXRlX2R5bmFtaWNfY29tbWFuZF9yZWdleCgpOiBSZWdFeHAge1xyXG4gICAgcmV0dXJuIC8oPCUoPzotfF8pP1xccypbKn5dezAsMX0pXFwrKCg/Oi58XFxzKSo/JT4pL2c7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiByZXNvbHZlX3Rmb2xkZXIoYXBwOiBBcHAsIGZvbGRlcl9zdHI6IHN0cmluZyk6IFRGb2xkZXIge1xyXG4gICAgZm9sZGVyX3N0ciA9IG5vcm1hbGl6ZVBhdGgoZm9sZGVyX3N0cik7XHJcblxyXG4gICAgY29uc3QgZm9sZGVyID0gYXBwLnZhdWx0LmdldEFic3RyYWN0RmlsZUJ5UGF0aChmb2xkZXJfc3RyKTtcclxuICAgIGlmICghZm9sZGVyKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IFRlbXBsYXRlckVycm9yKGBGb2xkZXIgXCIke2ZvbGRlcl9zdHJ9XCIgZG9lc24ndCBleGlzdGApO1xyXG4gICAgfVxyXG4gICAgaWYgKCEoZm9sZGVyIGluc3RhbmNlb2YgVEZvbGRlcikpIHtcclxuICAgICAgICB0aHJvdyBuZXcgVGVtcGxhdGVyRXJyb3IoYCR7Zm9sZGVyX3N0cn0gaXMgYSBmaWxlLCBub3QgYSBmb2xkZXJgKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gZm9sZGVyO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gcmVzb2x2ZV90ZmlsZShhcHA6IEFwcCwgZmlsZV9zdHI6IHN0cmluZyk6IFRGaWxlIHtcclxuICAgIGZpbGVfc3RyID0gbm9ybWFsaXplUGF0aChmaWxlX3N0cik7XHJcblxyXG4gICAgY29uc3QgZmlsZSA9IGFwcC52YXVsdC5nZXRBYnN0cmFjdEZpbGVCeVBhdGgoZmlsZV9zdHIpO1xyXG4gICAgaWYgKCFmaWxlKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IFRlbXBsYXRlckVycm9yKGBGaWxlIFwiJHtmaWxlX3N0cn1cIiBkb2Vzbid0IGV4aXN0YCk7XHJcbiAgICB9XHJcbiAgICBpZiAoIShmaWxlIGluc3RhbmNlb2YgVEZpbGUpKSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IFRlbXBsYXRlckVycm9yKGAke2ZpbGVfc3RyfSBpcyBhIGZvbGRlciwgbm90IGEgZmlsZWApO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBmaWxlO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0X3RmaWxlc19mcm9tX2ZvbGRlcihcclxuICAgIGFwcDogQXBwLFxyXG4gICAgZm9sZGVyX3N0cjogc3RyaW5nXHJcbik6IEFycmF5PFRGaWxlPiB7XHJcbiAgICBjb25zdCBmb2xkZXIgPSByZXNvbHZlX3Rmb2xkZXIoYXBwLCBmb2xkZXJfc3RyKTtcclxuXHJcbiAgICBjb25zdCBmaWxlczogQXJyYXk8VEZpbGU+ID0gW107XHJcbiAgICBWYXVsdC5yZWN1cnNlQ2hpbGRyZW4oZm9sZGVyLCAoZmlsZTogVEFic3RyYWN0RmlsZSkgPT4ge1xyXG4gICAgICAgIGlmIChmaWxlIGluc3RhbmNlb2YgVEZpbGUpIHtcclxuICAgICAgICAgICAgZmlsZXMucHVzaChmaWxlKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICBmaWxlcy5zb3J0KChhLCBiKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIGEucGF0aC5sb2NhbGVDb21wYXJlKGIucGF0aCk7XHJcbiAgICB9KTtcclxuXHJcbiAgICByZXR1cm4gZmlsZXM7XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBwb3B1bGF0ZV9kb2NzX2Zyb21fdXNlcl9zY3JpcHRzKFxyXG4gICAgYXBwOiBBcHAsXHJcbiAgICBmaWxlczogQXJyYXk8VEZpbGU+XHJcbik6IFByb21pc2U8VEpEb2NGaWxlW10+IHtcclxuICAgIGNvbnN0IGRvY0ZpbGVzID0gYXdhaXQgUHJvbWlzZS5hbGwoZmlsZXMubWFwKGFzeW5jIGZpbGUgPT4ge1xyXG4gICAgICAgICAgICAvLyBHZXQgZmlsZSBjb250ZW50c1xyXG4gICAgICAgICAgICBjb25zdCBjb250ZW50ID0gYXdhaXQgYXBwLnZhdWx0LmNhY2hlZFJlYWQoZmlsZSlcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGNvbnN0IG5ld0RvY0ZpbGUgPSBnZW5lcmF0ZV9qc2RvYyhmaWxlLCBjb250ZW50KTtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHJldHVybiBuZXdEb2NGaWxlO1xyXG4gICAgICAgIH1cclxuICAgICkpO1xyXG5cclxuICAgIHJldHVybiBkb2NGaWxlcztcclxufVxyXG5cclxuZnVuY3Rpb24gZ2VuZXJhdGVfanNkb2MoXHJcbiAgICBmaWxlOiBURmlsZSxcclxuICAgIGNvbnRlbnQ6IHN0cmluZ1xyXG4pOiBUSkRvY0ZpbGV7XHJcbiAgICAvLyBQYXJzZSB0aGUgY29udGVudFxyXG4gICAgY29uc3QgdHNkb2NQYXJzZXIgPSBuZXcgVFNEb2NQYXJzZXIoKTtcclxuICAgIGNvbnN0IHBhcnNlZERvYyA9IHRzZG9jUGFyc2VyLnBhcnNlU3RyaW5nKGNvbnRlbnQpO1xyXG5cclxuICAgIC8vIENvcHkgYW5kIGV4dHJhY3QgaW5mb3JtYXRpb24gaW50byB0aGUgVEpEb2NGaWxlXHJcbiAgICBjb25zdCBuZXdEb2NGaWxlID0gbmV3IFRKRG9jRmlsZShmaWxlKTtcclxuXHJcbiAgICBuZXdEb2NGaWxlLmRlc2NyaXB0aW9uID0gZ2VuZXJhdGVfanNkb2NfZGVzY3JpcHRpb24ocGFyc2VkRG9jLmRvY0NvbW1lbnQuc3VtbWFyeVNlY3Rpb24pO1xyXG4gICAgbmV3RG9jRmlsZS5yZXR1cm5zID0gZ2VuZXJhdGVfanNkb2NfcmV0dXJuKHBhcnNlZERvYy5kb2NDb21tZW50LnJldHVybnNCbG9jayk7XHJcbiAgICBuZXdEb2NGaWxlLmFyZ3VtZW50cyA9IGdlbmVyYXRlX2pzZG9jX2FyZ3VtZW50cyhwYXJzZWREb2MuZG9jQ29tbWVudC5wYXJhbXMpO1xyXG5cclxuICAgIHJldHVybiBuZXdEb2NGaWxlXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdlbmVyYXRlX2pzZG9jX2Rlc2NyaXB0aW9uKFxyXG4gICAgc3VtbWFyeVNlY3Rpb246IERvY1NlY3Rpb25cclxuKSA6IHN0cmluZyB7XHJcbiAgICB0cnkge1xyXG4gICAgICAgIGNvbnN0IGRlc2NyaXB0aW9uID0gc3VtbWFyeVNlY3Rpb24ubm9kZXMubWFwKChub2RlOiBEb2NOb2RlKSA9PiBcclxuICAgICAgICAgICAgbm9kZS5nZXRDaGlsZE5vZGVzKClcclxuICAgICAgICAgICAgICAgIC5maWx0ZXIoKG5vZGU6IERvY05vZGUpID0+IG5vZGUgaW5zdGFuY2VvZiBEb2NQbGFpblRleHQpXHJcbiAgICAgICAgICAgICAgICAubWFwKCh4OiBEb2NQbGFpblRleHQpID0+IHgudGV4dClcclxuICAgICAgICAgICAgICAgIC5qb2luKFwiXFxuXCIpXHJcbiAgICAgICAgKTtcclxuICAgIFxyXG4gICAgICAgIHJldHVybiBkZXNjcmlwdGlvbi5qb2luKFwiXFxuXCIpOyAgIFxyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gcGFyc2Ugc3VtYW1yeSBzZWN0aW9uJyk7XHJcbiAgICAgICAgdGhyb3cgZXJyb3I7XHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdlbmVyYXRlX2pzZG9jX3JldHVybihcclxuICAgIHJldHVyblNlY3Rpb24gOiBEb2NCbG9jayB8IHVuZGVmaW5lZFxyXG4pOiBzdHJpbmcge1xyXG4gICAgaWYgKCFyZXR1cm5TZWN0aW9uKSByZXR1cm4gXCJcIjtcclxuXHJcbiAgICB0cnkge1xyXG4gICAgICAgIGNvbnN0IHJldHVyblZhbHVlID0gcmV0dXJuU2VjdGlvbi5jb250ZW50Lm5vZGVzWzBdLmdldENoaWxkTm9kZXMoKVswXS50ZXh0LnRyaW0oKTtcclxuICAgICAgICByZXR1cm4gcmV0dXJuVmFsdWU7ICAgXHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgIHJldHVybiBcIlwiO1xyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBnZW5lcmF0ZV9qc2RvY19hcmd1bWVudHMoXHJcbiAgICBwYXJhbVNlY3Rpb246IERvY1BhcmFtQ29sbGVjdGlvblxyXG4pIDogVEpEb2NGaWxlQXJndW1lbnRbXSB7XHJcbiAgICB0cnkge1xyXG4gICAgICAgIGNvbnN0IGJsb2NrcyA9IHBhcmFtU2VjdGlvbi5ibG9ja3M7XHJcbiAgICAgICAgY29uc3QgYXJncyA9IGJsb2Nrcy5tYXAoKGJsb2NrKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBuYW1lID0gYmxvY2sucGFyYW1ldGVyTmFtZTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGRlc2NyaXB0aW9uID0gYmxvY2suY29udGVudC5nZXRDaGlsZE5vZGVzKClbMF0uZ2V0Q2hpbGROb2RlcygpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZmlsdGVyKHggPT4geCBpbnN0YW5jZW9mIERvY1BsYWluVGV4dClcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5tYXAoeCA9PiB4LnRleHQpLmpvaW4oXCIgXCIpXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFRKRG9jRmlsZUFyZ3VtZW50KG5hbWUsIGRlc2NyaXB0aW9uKTtcclxuICAgICAgICAgICAgfSlcclxuXHJcbiAgICAgICAgcmV0dXJuIGFyZ3M7ICAgXHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgIHJldHVybiBbXTtcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGFycmF5bW92ZTxUPihcclxuICAgIGFycjogVFtdLFxyXG4gICAgZnJvbUluZGV4OiBudW1iZXIsXHJcbiAgICB0b0luZGV4OiBudW1iZXJcclxuKTogdm9pZCB7XHJcbiAgICBpZiAodG9JbmRleCA8IDAgfHwgdG9JbmRleCA9PT0gYXJyLmxlbmd0aCkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IGVsZW1lbnQgPSBhcnJbZnJvbUluZGV4XTtcclxuICAgIGFycltmcm9tSW5kZXhdID0gYXJyW3RvSW5kZXhdO1xyXG4gICAgYXJyW3RvSW5kZXhdID0gZWxlbWVudDtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldF9hY3RpdmVfZmlsZShhcHA6IEFwcCkge1xyXG4gICAgcmV0dXJuIGFwcC53b3Jrc3BhY2UuYWN0aXZlRWRpdG9yPy5maWxlID8/IGFwcC53b3Jrc3BhY2UuZ2V0QWN0aXZlRmlsZSgpO1xyXG59XHJcblxyXG4vKipcclxuICogQHBhcmFtIHBhdGggTm9ybWFsaXplZCBmaWxlIHBhdGhcclxuICogQHJldHVybnMgRm9sZGVyIHBhdGhcclxuICogQGV4YW1wbGVcclxuICogZ2V0X2ZvbGRlcl9wYXRoX2Zyb21fcGF0aChub3JtYWxpemVQYXRoKFwicGF0aC90by9mb2xkZXIvZmlsZVwiLCBcIm1kXCIpKSAvLyBwYXRoL3RvL2ZvbGRlclxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGdldF9mb2xkZXJfcGF0aF9mcm9tX2ZpbGVfcGF0aChwYXRoOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IHBhdGhfc2VwYXJhdG9yID0gcGF0aC5sYXN0SW5kZXhPZihcIi9cIik7XHJcbiAgICBpZiAocGF0aF9zZXBhcmF0b3IgIT09IC0xKSByZXR1cm4gcGF0aC5zbGljZSgwLCBwYXRoX3NlcGFyYXRvcik7XHJcbiAgICByZXR1cm4gXCJcIjtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGlzX29iamVjdChvYmo6IHVua25vd24pOiBvYmogaXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4ge1xyXG4gICAgcmV0dXJuIG9iaiAhPT0gbnVsbCAmJiB0eXBlb2Ygb2JqID09PSBcIm9iamVjdFwiO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0X2ZuX3BhcmFtcyhmdW5jOiAoLi4uYXJnczogdW5rbm93bltdKSA9PiB1bmtub3duKSB7XHJcbiAgICBjb25zdCBzdHIgPSBmdW5jLnRvU3RyaW5nKCk7XHJcbiAgICBjb25zdCBsZW4gPSBzdHIuaW5kZXhPZihcIihcIik7XHJcbiAgICByZXR1cm4gc3RyXHJcbiAgICAgICAgLnN1YnN0cmluZyhsZW4gKyAxLCBzdHIuaW5kZXhPZihcIilcIikpXHJcbiAgICAgICAgLnJlcGxhY2UoLyAvZywgXCJcIilcclxuICAgICAgICAuc3BsaXQoXCIsXCIpO1xyXG59XHJcblxyXG4vKipcclxuICogVXNlIGEgcGFyZW50IEh0bWxFbGVtZW50IHRvIGNyZWF0ZSBhIGxhYmVsIHdpdGggYSB2YWx1ZVxyXG4gKiBAcGFyYW0gcGFyZW50IFRoZSBwYXJlbnQgSHRtbEVsZW1lbnQ7IFVzZSBIdG1sT0xpc3RFbGVtZW50IHRvIHJldHVybiBhIGBsaWAgZWxlbWVudFxyXG4gKiBAcGFyYW0gdGl0bGUgVGhlIHRpdGxlIGZvciB0aGUgbGFiZWwgd2hpY2ggd2lsbCBiZSBib2xkZWRcclxuICogQHBhcmFtIHZhbHVlIFRoZSB2YWx1ZSBvZiB0aGUgbGFiZWxcclxuICogQHJldHVybnMgQSBsYWJlbCBIdG1sRWxlbWVudCAocCB8IGxpKVxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGFwcGVuZF9ib2xkZWRfbGFiZWxfd2l0aF92YWx1ZV90b19wYXJlbnQoXHJcbiAgICBwYXJlbnQ6IEhUTUxFbGVtZW50LFxyXG4gICAgIHRpdGxlOiBzdHJpbmcsXHJcbiAgICAgdmFsdWU6IHN0cmluZ1xyXG4pOiBIVE1MRWxlbWVudHtcclxuICAgIGNvbnN0IHRhZyA9IHBhcmVudCBpbnN0YW5jZW9mIEhUTUxPTGlzdEVsZW1lbnQgPyBcImxpXCIgOiBcInBcIjsgIFxyXG5cclxuICAgIGNvbnN0IHBhcmEgPSBwYXJlbnQuY3JlYXRlRWwodGFnKTtcclxuICAgIGNvbnN0IGJvbGQgPSBwYXJlbnQuY3JlYXRlRWwoJ2InLCB7dGV4dDogdGl0bGV9KTtcclxuICAgIHBhcmEuYXBwZW5kQ2hpbGQoYm9sZCk7XHJcbiAgICBwYXJhLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKGA6ICR7dmFsdWV9YCkpXHJcblxyXG4gICAgLy8gUmV0dXJucyBhIHAgb3IgbGkgZWxlbWVudFxyXG4gICAgLy8gUmVzdWx0aW5nIGluIDxiPlRpdGxlPC9iPjogdmFsdWVcclxuICAgIHJldHVybiBwYXJhO1xyXG59XHJcbiJdfQ==